<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blood Bank Dashboard - RaktaSetu</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="config.js"></script>
  <style>
    body { font-family: 'Poppins', sans-serif; }
    .donor-row { display: grid; grid-template-columns: repeat(6, 1fr) 100px; gap: 10px; margin: 10px 0; }
    .donor-row input, .donor-row select { padding: 8px; border: 1px solid #ddd; border-radius: 5px; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-blue-50 min-h-screen">
  <nav class="bg-white shadow-lg sticky top-0 z-50">
    <div class="container mx-auto px-4">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center space-x-2">
          <span class="text-3xl">üè•</span>
          <span class="text-2xl font-bold text-blue-600">RaktaSetu Blood Bank</span>
        </div>
        <div class="flex items-center space-x-6">
          <span id="bloodBankName" class="font-semibold"></span>
          <button onclick="logout()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">Logout</button>
        </div>
      </div>
    </div>
  </nav>

  <div class="container mx-auto px-4 py-8">
    <h1 class="text-4xl font-bold text-gray-800 mb-8">Donor Management</h1>
    
    <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">Add Donors (Bulk)</h2>
      <div id="donorRows">
        <div class="donor-row">
          <input type="text" placeholder="Name" class="donor-name" required>
          <input type="email" placeholder="Email" class="donor-email" required>
          <input type="tel" placeholder="Phone" class="donor-phone" required>
          <select class="donor-blood" required>
            <option value="">Blood Type</option>
            <option value="A+">A+</option>
            <option value="A-">A-</option>
            <option value="B+">B+</option>
            <option value="B-">B-</option>
            <option value="AB+">AB+</option>
            <option value="AB-">AB-</option>
            <option value="O+">O+</option>
            <option value="O-">O-</option>
          </select>
          <input type="text" placeholder="City" class="donor-city" required>
          <input type="text" placeholder="State" class="donor-state" required>
          <button type="button" onclick="removeRow(this)" class="bg-red-600 text-white px-3 py-2 rounded hover:bg-red-700">Remove</button>
        </div>
      </div>
      <div class="flex gap-4 mt-4">
        <button type="button" onclick="addRow()" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700">+ Add Row</button>
        <button type="button" onclick="submitDonors()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">Submit All Donors</button>
      </div>
    </div>

    <div class="bg-white rounded-2xl shadow-xl p-8">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">Registered Donors</h2>
      <div id="donorsList"></div>
    </div>
  </div>

  <script src="js/app.js"></script>
  <script>
    async function checkAuth() {
      const res = await fetch(API_URL + '/api/bloodbank/check-auth', { credentials: 'include' });
      const data = await res.json();
      if (!data.authenticated) {
        window.location.href = 'login.html';
      } else {
        document.getElementById('bloodBankName').textContent = data.bloodBank;
        loadDonors();
      }
    }

    function addRow() {
      const row = document.createElement('div');
      row.className = 'donor-row';
      row.innerHTML = `
        <input type="text" placeholder="Name" class="donor-name" required>
        <input type="email" placeholder="Email" class="donor-email" required>
        <input type="tel" placeholder="Phone" class="donor-phone" required>
        <select class="donor-blood" required>
          <option value="">Blood Type</option>
          <option value="A+">A+</option>
          <option value="A-">A-</option>
          <option value="B+">B+</option>
          <option value="B-">B-</option>
          <option value="AB+">AB+</option>
          <option value="AB-">AB-</option>
          <option value="O+">O+</option>
          <option value="O-">O-</option>
        </select>
        <input type="text" placeholder="City" class="donor-city" required>
        <input type="text" placeholder="State" class="donor-state" required>
        <button type="button" onclick="removeRow(this)" class="bg-red-600 text-white px-3 py-2 rounded hover:bg-red-700">Remove</button>
      `;
      document.getElementById('donorRows').appendChild(row);
    }

    function removeRow(btn) {
      if (document.querySelectorAll('.donor-row').length > 1) {
        btn.parentElement.remove();
      }
    }

    async function submitDonors() {
      const rows = document.querySelectorAll('.donor-row');
      const donors = [];
      
      rows.forEach(row => {
        donors.push({
          name: row.querySelector('.donor-name').value,
          email: row.querySelector('.donor-email').value,
          phone: row.querySelector('.donor-phone').value,
          blood_type: row.querySelector('.donor-blood').value,
          city: row.querySelector('.donor-city').value,
          state: row.querySelector('.donor-state').value,
          date_of_birth: '1990-01-01',
          gender: 'Other',
          weight: 60,
          height: 170,
          pincode: '000000',
          address: 'Blood Bank',
          emergency_contact: row.querySelector('.donor-phone').value,
          relation: 'Self',
          willing_to_donate: true
        });
      });

      const res = await fetch(API_URL + '/api/bloodbank/donors', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ donors }),
        credentials: 'include'
      });

      const result = await res.json();
      if (result.success) {
        showToast(`${result.count} donors added successfully!`);
        document.getElementById('donorRows').innerHTML = '';
        addRow();
        loadDonors();
      } else {
        showToast(result.error, 'error');
      }
    }

    async function loadDonors() {
      const res = await fetch(API_URL + '/api/bloodbank/donors', { credentials: 'include' });
      const donors = await res.json();
      
      const html = donors.map(d => `
        <div class="border border-gray-200 rounded-lg p-4 mb-3 flex justify-between items-center hover:shadow-md transition">
          <div>
            <p class="font-bold text-lg">${d.name}</p>
            <p class="text-gray-600">${d.blood_type} | ${d.phone} | ${d.city}, ${d.state}</p>
            <p class="text-sm text-gray-500">Donations: ${d.donation_count || 0} | Last: ${d.last_donation_date || 'Never'}</p>
          </div>
          <button onclick="deleteDonor('${d._id}')" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Delete</button>
        </div>
      `).join('');
      
      document.getElementById('donorsList').innerHTML = html || '<p class="text-gray-500 text-center py-8">No donors registered yet.</p>';
    }

    async function deleteDonor(id) {
      if (!confirm('Delete this donor?')) return;
      
      const res = await fetch(API_URL + `/api/bloodbank/donors/${id}`, {
        method: 'DELETE',
        credentials: 'include'
      });
      
      const result = await res.json();
      if (result.success) {
        showToast('Donor deleted');
        loadDonors();
      }
    }

    async function logout() {
      await fetch(API_URL + '/api/bloodbank/logout', { method: 'POST', credentials: 'include' });
      window.location.href = 'login.html';
    }

    checkAuth();
  </script>
</body>
</html>
